@page
@model _231046Y_Assignment2.Pages.ChangePasswordModel
@{
    ViewData["Title"] = "Change Password - Fresh Farm Market";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Change Password</h3>
                </div>
                <div class="card-body">
                    @if (Model.MustChangePassword)
                    {
                        <div class="alert alert-warning">
                            <strong>Password Expired:</strong> Your password has expired. Please change it now.
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
                    {
                        <div class="alert alert-success">@Model.SuccessMessage</div>
                    }

                    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                    {
                        <div class="alert alert-danger">@Model.ErrorMessage</div>
                    }

                    <form method="post">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <div class="mb-3">
                            <label asp-for="ChangePassword.CurrentPassword" class="form-label"></label>
                            <input asp-for="ChangePassword.CurrentPassword" class="form-control" type="password" />
                            <span asp-validation-for="ChangePassword.CurrentPassword" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ChangePassword.NewPassword" class="form-label"></label>
                            <input asp-for="ChangePassword.NewPassword" class="form-control" type="password" id="newPassword" />
                            <div id="passwordStrength" class="mt-2"></div>
                            <small class="form-text text-muted">Minimum 12 characters with uppercase, lowercase, numbers, and special characters.</small>
                            <span asp-validation-for="ChangePassword.NewPassword" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ChangePassword.ConfirmNewPassword" class="form-label"></label>
                            <input asp-for="ChangePassword.ConfirmNewPassword" class="form-control" type="password" />
                            <span asp-validation-for="ChangePassword.ConfirmNewPassword" class="text-danger"></span>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">Change Password</button>
                            <a asp-page="/Index" class="btn btn-link">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.getElementById('newPassword').addEventListener('input', function() {
            var password = this.value;
            var strengthDiv = document.getElementById('passwordStrength');
            var strength = checkPasswordStrength(password);
            
            strengthDiv.innerHTML = strength.html;
            strengthDiv.className = 'mt-2 ' + strength.class;
        });

        function checkPasswordStrength(password) {
            var score = 0;
            var feedback = [];

            if (password.length >= 12) {
                score += 2;
            } else {
                feedback.push('At least 12 characters');
            }

            if (/[a-z]/.test(password)) {
                score += 1;
            } else {
                feedback.push('Lowercase letter');
            }

            if (/[A-Z]/.test(password)) {
                score += 1;
            } else {
                feedback.push('Uppercase letter');
            }

            if (/[0-9]/.test(password)) {
                score += 1;
            } else {
                feedback.push('Number');
            }

            if (/[!@@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
                score += 1;
            } else {
                feedback.push('Special character');
            }

            var html = '';
            var className = '';

            if (score >= 6) {
                html = '<span class="badge bg-success">STRONG Password</span>';
                className = 'text-success';
            } else if (score >= 4) {
                html = '<span class="badge bg-warning">Medium Password</span><br><small>Missing: ' + feedback.join(', ') + '</small>';
                className = 'text-warning';
            } else {
                html = '<span class="badge bg-danger">Weak Password</span><br><small>Missing: ' + feedback.join(', ') + '</small>';
                className = 'text-danger';
            }

            return { html: html, class: className };
        }
    </script>
}
